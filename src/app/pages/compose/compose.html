<section class="row gx-5 justify-content-center">
    <article class="col-lg-11 col-xl-9 col-xxl-8">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bolder mb-0"><span class="text-gradient d-inline">Crear paleta de colores</span></h1>
            <p class="lead fw-light mt-3">Sigue los pasos del asistente para generar una gama cromática a través de la inteligencia artificial.</p>
        </div>

        <div class="row gx-5 justify-content-center">
            <div class="col-lg-10 col-xl-10">
                <!-- =================================================================== -->
                <!-- PASO 1 — Concepto / Prompt -->
                <!-- =================================================================== -->
                <div class="card border-dark fade-in mb-4"
                    [class.show]="!hide(conceptStep)" [class.hidden]="hide(conceptStep)">
                    <app-step-overlay [step]="conceptStep" [loading]="loading"
                        (editStep)="setStep($event)"></app-step-overlay>

                    <div class="card-body">
                        <h5 class="card-title fw-bold">Paso 1 — Concepto creativo</h5>
                        <h6 class="card-subtitle mb-3 text-body-secondary">Define los parámetros para la elección del color</h6>
                        
                        <!-- Prompt base -->
                        <div class="mb-3">
                            <label for="promptInput" class="form-label">Describe un contexto, emoción o estilo visual</label>

                            <input type="text" id="promptInput" class="form-control"
                                placeholder="Ej: nostalgia urbana, minimalismo cálido..."
                                [(ngModel)]="conceptStep.data.context"
                                [class.disabled]="loading" [disabled]="loading" [readonly]="loading">
                        </div>

                        <!-- IA Prompt -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="aiPrompt" class="form-label mb-0">
                                    (Opcional) Sugerencia de la IA
                                </label>

                                <btn-spinner label="Generar prompt" btnClass="btn btn-outline-primary btn-sm ms-3"
                                    iconClass="bi bi-stars" iconPosition="end"
                                    [loading]="loadingPrompt" [disabled]="loading"
                                    (click)="onClickBtnPrompt()"></btn-spinner>
                            </div>

                            <textarea id="aiPrompt" class="form-control" rows="2"
                                placeholder="Sugerencia generada por la IA..."
                                [(ngModel)]="conceptStep.data.suggestion"
                                [class.disabled]="loading" [disabled]="loading" [readonly]="loading"
                            ></textarea>
                        </div>
                        
                        <!-- Obtener color base -->
                        <btn-spinner label="Obtener color base" btnClass="btn btn-primary"
                            iconClass="bi bi-stars" iconPosition="end"
                            [loading]="loadingColorBase" [disabled]="loading"
                            (click)="onClickBtnColorBase()"></btn-spinner>

                        <app-error-alert [error]="conceptStep.error" [alertClass]="'mb-0 mt-3'"></app-error-alert>
                    </div>
                </div>

                <!-- =================================================================== -->
                <!-- PASO 2 — Color Base -->
                <!-- =================================================================== -->
                <div class="card border-dark fade-in mb-4"
                    [class.show]="!hide(baseColorStep)" [class.hidden]="hide(baseColorStep)">
                    <app-step-overlay [step]="baseColorStep" [loading]="loading"
                        (editStep)="setStep($event)"></app-step-overlay>

                    <div class="card-body">
                        <h5 class="card-title fw-bold">Paso 2 — Color base</h5>
                        <h6 class="card-subtitle mb-4 text-body-secondary">Genera un color base a partir del concepto creativo</h6>

                        <div class="row mb-3">
                            <!-- Swatch -->
                            <div class="col-md-4 text-center">
                                <div id="colorPreview" class="rounded mb-2 border"
                                    style="height: 157px" [style.background]="baseColorStep.data.hex"></div>

                                <small class="text-muted">Previsualización</small>
                            </div>

                            <div class="col-md-8">
                                <div class="row mb-1">
                                    <div class="col-md-8">
                                        <!-- HEX -->
                                        <div class="mb-3">
                                            <label for="hexOutput" class="form-label">Código hexadecimal</label>

                                            <input type="text" id="hexOutput" class="form-control" pattern="^#([A-Fa-f0-9]{6})$"
                                                [(ngModel)]="baseColorStep.data.hex" (ngModelChange)="syncColorFromHEX()"
                                                [class.disabled]="loading" [disabled]="loading" [readonly]="loading">
                                        </div>

                                        <!-- RGB -->
                                        <div class="mb-3">
                                            <label class="form-label">Código RGB</label>

                                            <div class="d-flex gap-2">
                                                <input type="number" class="form-control" min="0" max="255" placeholder="R"
                                                    [(ngModel)]="baseColorStep.data.r" (ngModelChange)="syncColorFromRGB()"
                                                    [class.disabled]="loading" [disabled]="loading" [readonly]="loading">

                                                <input type="number" class="form-control" min="0" max="255" placeholder="G"
                                                    [(ngModel)]="baseColorStep.data.g" (ngModelChange)="syncColorFromRGB()"
                                                    [class.disabled]="loading" [disabled]="loading" [readonly]="loading">

                                                <input type="number" class="form-control" min="0" max="255" placeholder="B"
                                                    [(ngModel)]="baseColorStep.data.b" (ngModelChange)="syncColorFromRGB()"
                                                    [class.disabled]="loading" [disabled]="loading" [readonly]="loading">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <!-- Color Picker -->
                                        <div>
                                            <label for="colorPicker" class="form-label">Ajuste manual</label>

                                            <input type="color" id="colorPicker" value="#FFFFFF"
                                                class="form-control form-control-color" title="Selecciona un color"
                                                [(ngModel)]="baseColorStep.data.hex" (ngModelChange)="syncColorFromHEX()"
                                                [class.disabled]="loading" [disabled]="loading" [readonly]="loading">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <!-- Definir esquema -->
                                <btn-spinner label="Definir esquema de color" btnClass="btn btn-gray"
                                    iconClass="bi bi-gear-fill" iconPosition="start"
                                    [loading]="loadingEsquema" [disabled]="loading"
                                    (click)="onClickBtnDefinirEsquema()"></btn-spinner>
                                    
                                <app-error-alert [error]="baseColorStep.error" [alertClass]="'mb-0 mt-3'"></app-error-alert>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =================================================================== -->
                <!-- PASO 3 — Selección del esquema -->
                <!-- =================================================================== -->
                <div class="card border-dark fade-in mb-4"
                    [class.show]="!hide(schemeStep)" [class.hidden]="hide(schemeStep)">
                    <app-step-overlay [step]="schemeStep" [loading]="loading"
                        (editStep)="setStep($event)"></app-step-overlay>
                    
                    <div class="card-body">
                        <h5 class="card-title fw-bold">Paso 3 — Construcción cromática</h5>
                        <h6 class="card-subtitle mb-1 text-body-secondary">Selecciona los parámetros de creación de la paleta de color</h6>

                        <div class="row">
                            <!-- Esquema -->
                            <div class="col-md-6 mt-3">
                                <label for="schemeSelect" class="form-label">
                                    Tipo de esquema cromático
                                </label>

                                <select id="schemeSelect" class="form-select"
                                        [(ngModel)]="schemeStep.data.type"
                                        [class.disabled]="loading" [disabled]="loading">
                                    <option value="" selected disabled>Selecciona un esquema...</option>
                                    <option value="complementary">Complementario</option>
                                    <option value="analogic">Análogo</option>
                                    <option value="triad">Triádico</option>
                                    <option value="monochrome">Monocromático</option>
                                    <option value="tetrad">Tetrádico</option>
                                </select>
                            </div>

                            <!-- Tonalidades -->
                            <div class="col-md-6 mt-3">
                                <label for="numColors" class="form-label">Número de tonalidades</label>

                                <input type="range" id="numColors" class="form-range"
                                    min="1" max="10" step="1" value="5"
                                    [(ngModel)]="schemeStep.data.tones"
                                    [class.disabled]="loading" [disabled]="loading" [readonly]="loading">

                                <div class="d-flex justify-content-between">
                                    <span>1</span>
                                    <span>5</span>
                                    <span>10</span>
                                </div>
                            </div>
                        </div>

                        <!-- Generar paleta -->
                        <btn-spinner label="Generar paleta final" btnClass="btn btn-success mt-3"
                            iconClass="bi bi-stars" iconPosition="end"
                            [loading]="loadingPaleta" [disabled]="loading"
                            (click)="onClickBtnGenerarPaleta()"></btn-spinner>
                            
                        <app-error-alert [error]="schemeStep.error" [alertClass]="'mb-0 mt-3'"></app-error-alert>
                    </div>
                </div>

                <!-- =================================================================== -->
                <!-- PASO 4 — Resultado final -->
                <!-- =================================================================== -->
                <div class="card border-dark fade-in mb-4"
                    [class.show]="!hide(resultStep)" [class.hidden]="hide(resultStep)">
                    <app-step-overlay [step]="resultStep" [loading]="loading"
                        (editStep)="setStep($event)"></app-step-overlay>
                    
                    <div class="card-body">
                        <h5 class="card-title fw-bold">Paso 4 — Paleta resultante</h5>
                        <h6 class="card-subtitle mb-4 text-body-secondary">Visualiza la paleta cromática generada</h6>

                        <div class="row row-cols-2 row-cols-md-5 g-3 mb-4">
                            <!-- Swatch de colores resultante -->
                            <div class="col">
                                <div class="bg-light rounded-3 text-center">
                                    <div style="background:#cccccc; height:100px;" class="rounded-top"></div>
                                    <div class="p-2">
                                        <div class="small fw-bolder">#CCCCCC</div>
                                        <div class="small text-muted">Gris suave</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="bg-light rounded-3 text-center">
                                    <div style="background:#cccccc; height:100px;" class="rounded-top"></div>
                                    <div class="p-2">
                                        <div class="small fw-bolder">#CCCCCC</div>
                                        <div class="small text-muted">Gris suave</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="bg-light rounded-3 text-center">
                                    <div style="background:#cccccc; height:100px;" class="rounded-top"></div>
                                    <div class="p-2">
                                        <div class="small fw-bolder">#CCCCCC</div>
                                        <div class="small text-muted">Gris suave</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="bg-light rounded-3 text-center">
                                    <div style="background:#cccccc; height:100px;" class="rounded-top"></div>
                                    <div class="p-2">
                                        <div class="small fw-bolder">#CCCCCC</div>
                                        <div class="small text-muted">Gris suave</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="bg-light rounded-3 text-center">
                                    <div style="background:#cccccc; height:100px;" class="rounded-top"></div>
                                    <div class="p-2">
                                        <div class="small fw-bolder">#CCCCCC</div>
                                        <div class="small text-muted">Gris suave</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Interpretación de la IA -->
                        <div class="mt-4">
                            <label for="aiInterpretation" class="form-label">
                                Lectura interpretativa
                            </label>

                            <textarea id="aiInterpretation" class="form-control" rows="4"
                                placeholder="Análisis generado por IA..."
                                disabled readonly
                            ></textarea>
                        </div>
                        
                        <div class="alert alert-success mt-3 mb-0 fade show" role="alert">
                            La paleta se ha <strong>generado</strong> y ha sido <strong>guardada en la biblioteca</strong> correctamente.
                        </div>

                        <app-error-alert [error]="resultStep.error" [alertClass]="'mb-0 mt-3'"></app-error-alert>
                    </div>
                </div>

                <!-- =================================================================== -->
                <!-- REINICIAR COMPOSICIÓN
                <!-- =================================================================== -->
                 @if (!initiated(resultStep)) {
                    <div class="text-end">
                        <button class="btn btn-outline-dark mb-2" routerLink="/library"
                            [class.disabled]="loading" [disabled]="loading">
                            <i class="bi bi-journals me-2"></i>
                            <span class="px-2">Explorar biblioteca</span>
                        </button>
                        <button class="btn btn-outline-danger mb-2 ms-3"
                            [class.disabled]="loading" [disabled]="loading"
                            data-bs-toggle="modal" data-bs-target="#modalReinicio">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            <span>Reiniciar composición</span>
                        </button>
                    </div>
                }

                <div class="modal" tabindex="-1" id="modalReinicio">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Reiniciar composición</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                        <div class="modal-body">
                            <p class="mb-0">¿Está seguro de que desea comenzar una nueva composición?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                                <i class="bi bi-x-lg me-2"></i>
                                <span>Cerrar</span>
                            </button>
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" (click)="restart()">
                                <i class="bi bi-trash me-2"></i>
                                <span>Reiniciar</span>
                            </button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </article>
</section>